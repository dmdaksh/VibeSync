{% extends "app/base.html" %}
{% load static %}
{% load embed_video_tags %}

{% block title %}Welcome{% endblock %}

{% block content %}

<!-- <link href="https://fonts.googleapis.com/css2?family=Lato&display=swap" rel="stylesheet"> -->
<link href="https://fonts.googleapis.com/css2?family=Lobster&display=swap" rel="stylesheet"> 
<style>
    #progress-report {
        height: 400px;
        overflow-y: auto;
        border: 1px solid #000000;
    }
    .progress-step {
        margin: 10px 0;
    }
    /* .loader {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3B71CA;
        animation: spin 1s linear infinite;
    } */

    @keyframes spin {
        0% {
            transform: rotate(0);
        }
        50% {
            transform: rotate(300deg);
        }
        66% {
            transform: rotate(270deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }
    .centered-image {
    display: block;
    margin-left: auto;
    margin-right: auto;
    width: 200px; /* Adjust the width as needed */
    height: 200px; /* Make height equal to the width to maintain aspect ratio */
    border-radius: 50%; /* This creates the circular shape */
    object-fit: cover; /* or any other percentage you see fit */
}

    h1{
        color: #16dfdc;
  font-size: 120px;
  font-family: 'Lobster', cursive;
    }
    h2{
        color: #353535;
  font-size: 50px;
        font-family: "Cormorant Garamond"
    }

    .custom-btn {
  width: 130px;
  height: 40px;
  color: #fff;
  border-radius: 5px;
  padding: 10px 25px;
  font-family: 'Lato', sans-serif;
  font-weight: 500;
  background: transparent;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
  display: inline-block;
   box-shadow:inset 2px 2px 2px 0px rgba(255,255,255,.5),
   7px 7px 20px 0px rgba(0,0,0,.1),
   4px 4px 5px 0px rgba(0,0,0,.1);
  outline: none;
}

/* 6 */
.btn-6 {
  background: rgb(21, 186, 227);
background: linear-gradient(circle, rgb(8, 112, 186) 0%, rgba(118,174,241,1) 100%);
  line-height: 42px;
  padding: 0;
  border: none;
}
.btn-6 span {
  position: relative;
  display: block;
  width: 100%;
  height: 100%;
}
.btn-6:before,
.btn-6:after {
  position: absolute;
  content: "";
  height: 0%;
  width: 1px;
 box-shadow:
   -1px -1px 20px 0px rgba(255,255,255,1),
   -4px -4px 5px 0px rgba(255,255,255,1),
   7px 7px 20px 0px rgba(0,0,0,.4),
   4px 4px 5px 0px rgba(0,0,0,.3);
}
.btn-6:before {
  right: 0;
  top: 0;
  transition: all 500ms ease;
}
.btn-6:after {
  left: 0;
  bottom: 0;
  transition: all 500ms ease;
}
.btn-6:hover{
  background: transparent;
  color: #76aef1;
  box-shadow: none;
}
.btn-6:hover:before {
  transition: all 500ms ease;
  height: 100%;
}
.btn-6:hover:after {
  transition: all 500ms ease;
  height: 100%;
}
.btn-6 span:before,
.btn-6 span:after {
  position: absolute;
  content: "";
  box-shadow:
   -1px -1px 20px 0px rgba(255,255,255,1),
   -4px -4px 5px 0px rgba(255,255,255,1),
   7px 7px 20px 0px rgba(0,0,0,.4),
   4px 4px 5px 0px rgba(0,0,0,.3);
}
.btn-6 span:before {
  left: 0;
  top: 0;
  width: 0%;
  height: .5px;
  transition: all 500ms ease;
}
.btn-6 span:after {
  right: 0;
  bottom: 0;
  width: 0%;
  height: .5px;
  transition: all 500ms ease;
}
.btn-6 span:hover:before {
  width: 100%;
}
.btn-6 span:hover:after {
  width: 100%;
}


</style>
 <link rel="stylesheet" href="https://cdn.plyr.io/3.7.2/plyr.css">

<div class="container mt-5">
    <img src="../../static/app/images/logo.png" alt="Logo" class="centered-image">
    <h1 class="text-center pt-5" style="color: ;">VibeSync</h1>
    <h2 class="text-center pt-5" style="color: ;">Enhance your videos with audio!</h2>
    <hr>
    <div class="d-flex flex-row justify-content-center mx-lg-auto max-lg-w-2xl max-xl-w-3xl"></div>
        <form method="post" id="id_videoform" enctype="multipart/form-data">
            {% csrf_token %}
        <!-- <div id="parent" class="d-flex w-full align-items-center">
            <div class="input-group mt-5 d-flex w-full align-items-center"> -->
                <!-- Input for file upload, with specific acceptance for video files -->
                <div class="input-group mt-5">
                    <input id="video" type="file" class="form-control flex-grow-1" style="min-width: 500px;"
                            accept="video/*" aria-label="Upload video" placeholder="Upload video here...">
                    <!-- Button to trigger the file upload action -->
                    <button id="submitVideo" type="button" class="custom-btn btn-6">
                        <i class="bi bi-camera-video" id="submitButton" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Upload video"></i> <b>Submit Video</b> 
                    </button>
                </div>
        </form>
    </div>
    <div class="row">
        <!-- video 1 -->
        <div class="col-md-8" id="video_left">
        </div>
        <!-- video 2 -->
        <div class="col-md-4" id="video_right">
            <!-- progress section -->
            <!-- <div id="progress-report" class="mb-3"> -->
                <!-- <div class="progress-step"></div> -->
                <!-- <p id="system_message_1">Understanding the image...</p>
                <p id="system_message_2">Understood. Now, looking for suitable audio...</p>
                <p id="system_message_3">Done! Working my editing magic now...</p>
                <p id="system_message_4">Ta-da! Here's the final outcome.</p> -->
            <!-- </div> -->
            
        </div>
    </div>
    <!-- submit button -->
    <div id="submitBtn" class="button" style="display: none;"></div>
</div>
{% endblock %}
{% block script %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.plyr.io/3.7.2/plyr.polyfilled.js"></script>

<script>
document.getElementById('submitBtn').onclick = function() {
    window.location.href = "{% url 'app:index' %}";
};
// let video_count = 0;
document.addEventListener('DOMContentLoaded', function(){

    document.getElementById('submitVideo').addEventListener("click", function(event) {
        event.preventDefault(); // prevent default submit behavior
        console.log("video saved");
        var post_url = window.location.href;
        var csrfToken = document.querySelector('input[name=csrfmiddlewaretoken]').value;
        var fileInput = document.getElementById('video');

        if (fileInput.files.length !== 1) {
            alert("Please upload a video file. (Limit 1)");
            return; // Stop the function if not exactly one file is uploaded
        }

        var formData = new FormData();
        var videoFile = fileInput.files[0]; 
        console.log(formData);
        formData.append('video', videoFile, "video.mp4"); 
        formData.append('csrfmiddlewaretoken', csrfToken); 
        formData.append('requestType', 'upload');

        // Submit the form data via AJAX
        $.ajax({
            type: 'POST',
            url: post_url, // Replace with your server endpoint URL
            data: formData,
            processData: false, // Prevent jQuery from converting the FormData into a string
            contentType: false, // Let the browser set the content type
            success: function(response) {
                console.log("Video uploaded successfully");
                document.getElementById('submitVideo').style.display = "none";
                document.getElementById('video').style.display = "none";
                // videoContainer = document.createElement('div');
                // videoContainer.id = 'videoContainer_' + video_count;
                // video_count = video_count++;
                
                // Create and append the video element
                var video = document.createElement('video');
                video.id = 'video_1';
                video.src = "{% static 'app/videos' %}" + response.fileUrl;
                video.width = 480;
                video.height = 320;
                video.controls = true;
                video.autoplay = true;  // Optional: play as soon as loaded

                document.getElementById('video_left').appendChild(video);
                // Clear previous videos if any and add new video
                videoContainer.innerHTML = '';  
                videoContainer.appendChild(video); 
                const player = new Plyr('video', {captions: {active: true}});

                // Expose player so it can be used from the console
                window.player = player;
                gemini(response.fileUrl);
                // // add gemini api call
                // var gemini = document.createElement('div');
                // gemini.appendChild('')
                // parent.appendChild();
            },
            error: function(xhr, status, error) {
                // Handle error response
                console.error(xhr.responseText);
                console.log("ERROR");
                document.getElementById('submitVideo').style.display = "block";
                document.getElementById('video').style.display = "block";
            }
        });

    });

    function gemini(fileUrl){
        var loader = document.createElement('div');
        loader.className = "loader";
        // document.getElementById('parent').appendChild(loader);
        var csrfToken = document.querySelector('input[name=csrfmiddlewaretoken]').value;
        var post_url = window.location.href;
        var postData = {
            'requestType': 'gemini',
            'file_url': fileUrl,
            csrfmiddlewaretoken: csrfToken
        };
        // call gemini api
        $.ajax({
            type: 'POST',
            url: post_url, // Replace with your server endpoint URL
            data: postData,
            success: function(response) {
                // document.getElementsByClassName('loader')[0].remove();
                // add system message from socket
                youtubeSearch(response.gemini_json)
            },
            error: function(xhr, status, error) {
                // Handle error response
                console.error(xhr.responseText);
                console.log("ERROR");
                document.getElementById('submitVideo').style.display = "block";
                document.getElementById('video').style.display = "block";
            }
        });
    }

    function youtubeSearch(geminiJson){
        var loader = document.createElement('div');
        loader.className = "loader";
        // document.getElementById('parent').appendChild(loader);

        var csrfToken = document.querySelector('input[name=csrfmiddlewaretoken]').value;
        var post_url = "{% url 'app:get_yt_link' %}"
        // serialize geminiJson
        geminiJson = JSON.stringify(geminiJson);
        var postData = {
            'gemini_response': geminiJson,
            csrfmiddlewaretoken: csrfToken
        };
        console.log(postData)
        // call yt search api
        $.ajax({
            type: 'POST',
            url: post_url, // Replace with your server endpoint URL
            data: postData,
            success: function(response) {
                // document.getElementsByClassName('loader')[0].remove();
                
                // display file in frontend
                var video = document.createElement('video');
                outputVideoUrl = "{% static 'app/videos' %}" + "/video_output.mp4";
                console.log(outputVideoUrl)
                video.src = outputVideoUrl
                video.id = 'video_2';
                video.width = 320;
                video.height = 240;
                video.controls = true;
                video.autoplay = true;  // Optional: play as soon as loaded

                document.getElementById('video_right').appendChild(video);
                document.getElementById('submitBtn').style.display = "block";

            },
            error: function(xhr, status, error) {
                // Handle error response
                console.error(xhr.responseText);
                console.log("ERROR");
            }
        });
    }

});

</script>

{% endblock %}